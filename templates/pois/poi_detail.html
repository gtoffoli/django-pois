{% extends "roma/roma_base.html" %}
{% load staticfiles i18n macros set_var %}
{% loadmacros pois/pois_macros.html %}

{% block head_title %}{{ poi_dict.prefixed_name }}, {{poi_dict.comune.0}}{% endblock %}
{% block meta_description %}{{ poi_dict.short }} - {% trans "Category" %}: {{ poi_dict.category }} - {% trans "Theme areas" %}: {{ theme_names }}{% endblock %}
{% block extra_meta %}<meta name="date" content="{{ poi_dict.modified }}">{% endblock %}

{% block content %}
    <div class="boxcontent">
        <div class="row mB10">
            <div class="col-md-12 col-lg-12">
                <div class="segnaposto notranslate">{% if poi_dict.comune.1 != 'roma' %}{{ poi_dict.zone_parent|upper }} - {% endif %}{{ poi_dict.comune.0|upper }}</div>
            </div>
            <div class="col-md-9 col-lg-10">
                <h1 class="notranslate">{{ poi_dict.prefixed_name }}</h1>
            </div>
            <div class="col-md-3 col-lg-2">
                <div class="actions">
                    {% if can_edit %}<div><a href="{% url "admin:pois_poi_change" poi_dict.id %}"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> <small>{% trans "edit" %}</small></a></div>{% endif %}
                    <div><a id="explore_viewport" href="#"><i class="fa fa-map-o" aria-hidden="true"></i> <small>{% trans "explore the resources in the neighbourhood" %}</small></a></div>
                    <div id="live-geolocation"></div>
                    {% comment %}MMR 20170920 <div id="muoviroma-percorso"></div>{% endcomment %}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 col-lg-6 mB20">
            {% if poi_dict.point %} 
                <div id="map" class="mapRes"></div>
            {% endif %}
            </div>
            <div class="col-md-6 col-lg-6 mB20">
                <div class="box-res box-scroll">
                    <div class="table-responsive"><table class="table table-striped table-res">
                        <tbody>
                        {% if poitype %}
                            <tr><th>{% trans "Category" %}:</th><td><a rel="tooltip" href="{{ poitype.url }}" title='{% trans "list the resources" %} {% trans "of the category" %} {{ poitype.name }}'>{{ poitype.name }}</a></td></tr>
                        {% endif %} 
                        {% if theme_list %}
                            <tr><th>{% trans "Theme areas" %}:</th>
                                <td><div class="summary">{% for theme in theme_list %}<div class="val">{{ theme.name }}</div>{% endfor %}</div></td>
                            </tr>
                        {% endif %} 
                        {% if poi_dict.host_name %}
                            <tr><th>{% trans "Hosted by" %}:</th><td><a href="{{ poi_dict.host_url }}"><span class="notranslate">{{ poi_dict.host_name }}</span></a></td></tr>
                        {% endif %} 
                        {% if poi_dict.short %}
                            <tr><th>{% trans "Shortly" %}:</th><td>{{ poi_dict.short }}</td></tr>
                        {% endif %}
                        {% if zone_list %}
                            <tr><th>{% trans "Zones" %}:</th>
                                <td><div class="summary">
                                {% for zone in zone_list %}
                                     <div class="val">
                                    {% if zone.slug %}
                                        <a rel="tooltip" href="/indice-zona/{{ zone.slug }}/" title="{% trans "list the resources" %} {% trans "located in the zone" %} {{ zone.name }}"><span class="notranslate">{{ zone.name }}</span></a>
                                    {% else %}
                                        <a rel="tooltip" href="{{ zone.url }}" title="{% trans "list the resources" %} {% trans "located in the zone" %} {{ zone.name }}"><span class="notranslate">{{ zone.name }}</span></a>
                                    {% endif %}
                                    </div>
                                {% endfor %}
                                </div></td>
                            </tr>
                        {% endif %}
                        <tr><th>{% trans "Address" %}:</th><td>
                        {% if  poi_dict.street_url %}<a rel="tooltip" href="{{ poi_dict.street_url }}" title="{% trans "show" %} {{ poi_dict.street_name }}"><span class="notranslate">{{ poi_dict.street_name }}</span></a><span class="notranslate">, {{ poi_dict.number }}</span>{% else %}<span class="notranslate">{{ poi_dict.street_address }}</span>{% endif %} - <a href="/indice-zona/{{poi_dict.cap }}/" rel="tooltip" title="{% trans "list the resources" %} {% trans "located in the zone with zipcode" %} {{poi_dict.cap }}"><span class="notranslate">{{ poi_dict.cap }}</span></a> {% if poi_dict.comune.1 == 'roma' %}<span class="notranslate">{{ poi_dict.comune.0 }}</span>{% else %}<a href="/indice-zona/{{poi_dict.comune.1}}/" rel="tooltip" title="{% trans "list the resources" %} {% trans "located in the town" %} {{ poi_dict.comune.0 }}"><span class="notranslate">{{ poi_dict.comune.0 }}</span></a>{% endif %}</td></tr>
                        <tr><th>{% trans "Phone" %}:</th><td>
                        {% if poi_dict.phones %}
                             <div class="summary notranslate">
                             {% for phone in poi_dict.phones %}
                                 <div class="val"{{ phone }}</div>
                             {% endfor %}
                             </div>
                        {% endif %}
                        </td></tr>
                        <tr><th>E-mail:</th><td>
                        {% if poi_dict.emails %}
                             <ul class="list-unstyled notranslate">
                             {% for email in poi_dict.emails %}
                                 <li><a rel="tooltip" href="{{ email.0 }}">{{ email.1 }}</a></li>
                             {% endfor %}
                             </ul>
                        {% endif %}
                        </td></tr>
                        <tr><th class="notranslate">Web:</th><td>
                        {% if poi_dict.webs %}
                            <ul class="list-unstyled">
                            {% for web in poi_dict.webs %}
                                <li><a rel="tooltip" href="{{ web.0 }}" target="_blank">{{ web.1 }}</a></li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                        </td></tr>
                        {% if poi_dict.routes %}
                            <tr><th>{% trans "Routes" %}:</th>
                                <td><ul class="list-unstyled notranslate">
                                {% for route in poi_dict.routes %}
                                    <li><a rel="tooltip" href="{{ route.friendly_url }}">{{ route.name }}</a></li>
                                {% endfor %}
                                </ul></td>
                            </tr>
                        {% endif %}
                        {% if poi_dict.affiliations %}
                            <tr><th>{% trans "Affiliation" %}:</th>
                                <td><ul class="list-unstyled">
                                {% for affiliation in poi_dict.affiliations %}
                                    <li>{% if affiliation.logo %}<img class="img-thumb" src="{{ affiliation.logo }} ">{% endif %}
                                        <a rel="tooltip" href="{{ affiliation.url }}"  title="{% trans "Show the profile of"|lower %} {{ affiliation.name }}"><span class="notranslate">{{ affiliation.name }}</span></a>
                                    </li>
                                {% endfor %}
                              </ul></td>
                            </tr>
                        {% endif %}
                        {% if poi_list %}
                            <tr><th>{% trans "affiliated resources"|capfirst %}:</th>
                                <td>
                                {% if poi_list|length <= 8 %}
                                    <div class="summary notranslate">
                                    {% for affiliated in poi_list %}
                                        <div class="val"><a rel="tooltip" href="{{ affiliated.url }}">{{ affiliated.name }}</a></div>
                                    {% endfor %}
                                    </div>
                                {% endif %}
                                {% if poi_list|length >= 2 %}
                                    <div><a rel="tooltip" href="{{ poi_dict.url }}rete/">{% trans "show"|capfirst %} {% trans "a map of" %} {% trans "affiliated resources" %}</a></div>
                                {% endif %}
                                </td>
                            </tr>
                        {% endif %}
                        {% if hosted_list %}
                            <tr><th>{% trans "Hosted resources" %}:</th>
                                <td><div class="summary notranslate">
                                {% for hosted in hosted_list %}
                                    <div class="val"><a rel="tooltip" href="{{ hosted.url }}">{{ hosted.name }}</a></div>
                                {% endfor %}
                                </div></td>
                            </tr>
                        {% endif %}
                        {% if n_caredby and n_caredby < 1000 %}
                           <tr><th>{% trans "network"|capfirst %}:</th>
                               <td><a rel="tooltip" href="{{ poi_dict.url }}mappa/">{% trans "show"|capfirst %} {% trans "a map of" %} {% trans "friend resources" %}</a></td>
                           </tr>
                        {% endif %}
                        </tbody>
                    </table></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 col-lg-6 mB20">
            {% if poi_dict.description %}
                <div class="box-res box-scroll back-box"><div class="pTB6LR12">{{ poi_dict.description|safe }}</div></div>
            {% else %}
                <div class="box-res text-center back-box display-box"><div><i class="fa fa-edit"></i> descrizione</div></div>
            {% endif %}
            </div>
            <div class="col-md-6 col-lg-6 mB20">
            {% if poi_dict.video %}
                <div class="box-res"><iframe style="width:100%; height:100%" src="http://{{ poi_dict.video }}?autoplay=1" frameborder="0" allowfullscreen=""></iframe></div>
            {% else %}
                <div class="box-res back-box display-box"><div><i class="fa fa-play"></i> video</div></div>
            {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 col-lg-6 mB20">
            {% if feeds %}
                <div class="box-res box-scroll back-box">
                {% for feed in feeds %}
                <div>
                    <div class="box-header">{% trans "articles from"|capfirst %} {% if feed.title %}{{ feed.title }}{% else %}<span class="notranslate">{{ poi.name }}</span>{% endif %}</div>
                    <ul class="list-unstyled pTB6LR12">
                    {% for entry in feed.entries|slice:":3" %}
                        {% if entry.title %}
                            <li class="mB10">
                                <div><a href="{{ entry.link }}" target="_new" title="{% trans "read the original article" %}">{{ entry.title }}</a></div>
                                <div><small>{{ entry.date }}</small></div>
                                <div><small>
                                {% if entry.summary %}
                                    {{ entry.summary|striptags|safe|truncatewords:80 }}
                                {% else %}
                                    {{ entry.content|striptags|safe|truncatewords:80 }}
                                {% endif %}
                                </small></div>
                            </li>
                        {% endif %}
                    {% endfor %}
                    </ul>
                </div>
                {% endfor %}
                </div>
            {% else %}
                <div class="box-res text-center back-box display-box"><div><i class="fa fa-rss"></i> rss</div></div>
            {% endif %}
            </div>
        </div>
        {% set careof = poi_dict.careof %}
        <div class="row">
            {% if careof %}
                <div  class="col-md-6 col-lg-6">
                    <div><strong>{% trans "This profile care of" %}: </strong>
                         {% if careof.logo_url %}<a rel="tooltip" href="{{ careof.web }}" title="{% trans "go to the website of" %} {{ careof.name }}"><img class="img-thumb" src="{{ careof.logo_url }}"></a>{% endif %}
                         <a rel="tooltip" href="{{ careof.url }}" title="{% trans "Show the profile of"|lower %} {{ careof.name }}"><span class="notranslate">{{ careof.name }}</span></a>
                    </div>
                </div>
            {% endif %}
            <div  class="{% if careof %}col-md-6 col-lg-6{% else %}col-md-12 col-lg-12{% endif %}">
                {% if request.GET.comment %}
                    <div><strong>{% trans "Thanks for your contribution" %}!</strong></div>
                {% else %}
                    <div>{% trans "If the information in this page isn't correct, up-to-date and complete" %}, <a href="/annota-risorsa/{{ poi_dict.slug }}/">{% trans "send us a note" %}</a>. {% trans "Thanks" %}!</div>
                {% endif %}
            </div>
        </div>   
    </div>
{% endblock content %}

{% if poi_dict.point %}
{% block mapjs %}
<script type="text/javascript" src="{% static "pois/pois_symbols.js" %}" ></script>
<script type="text/javascript" src="{% static "pois/geoPosition.js" %}" ></script>
<script type="text/javascript" src="{% static "pois/pois_map.js" %}" ></script>

<script type="text/javascript">
var poi_style = new OpenLayers.Style({
        'fillColor': '#77DDFF',
        'fillOpacity': .8,
        'strokeColor': '${icon_color}',
        'strokeWidth': 1,
        'pointRadius': '${radius}',
        'label': '',
        'labelAlign': 'cm',
        'fontFamily': 'arial',
        'fontSize': '14px',
        'graphicName': '${icon_name}',
    },
    { 'context': {
        radius: function(feature) {
            return Math.max(5, 2 * (feature.layer.map.getZoom() - 8));
        }}
    }
);

var poi_style_selected = new OpenLayers.Style({
        'strokeWidth': 2,
        'label': '${name}',
    }
);
var poi_style_map = new OpenLayers.StyleMap({
    'default': poi_style,
    'select': poi_style_selected,
});
function map_init(){
    map = new OpenLayers.Map('map', {
        projection: proj_OSM,
// controls: [new OpenLayers.Control.Navigation(),],
});
    map.div.oncontextmenu = function noContextMenu(e){return false;};
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.addControl(new OpenLayers.Control.ScaleLine({geodesic: 'true'}));
    var gmap = new OpenLayers.Layer.Google("Google Streets", { numZoomLevels: 20 });
    map.addLayer(gmap);
/*
var gsat = new OpenLayers.Layer.Google("Google Satellite", {type: google.maps.MapTypeId.SATELLITE, numZoomLevels: 22});
map.addLayer(gsat);
var osm = new OpenLayers.Layer.OSM("OpenStreetMap");
map.addLayer(osm);
*/
// var blank = new OpenLayers.Layer("Blank", {isBaseLayer: true}); map.addLayer(blank);
    geojson_format = new OpenLayers.Format.GeoJSON();
    pois = new OpenLayers.Layer.Vector("Risorsa");
// poi = geojson_format.read({{poi.point_OSM.geojson|safe}})[0]; // We mark it 'safe' so that Django doesn't escape the quotes.
    poi = geojson_format.read({{poi_dict.point|safe}})[0]; // We mark it 'safe' so that Django doesn't escape the quotes.
// poi.attributes = { id: {{poi.id}}, name: "{{poi.safe_name}}", type: "{{poi.poitype}}", icon_name: "{{poi.icon_name}}", icon_color: "{{poi.icon_color}}" };
    poi.attributes = { id: {{poi_dict.id}}, name: "{{poi_dict.safe_name}}", icon_name: "{{poi_dict.icon}}", icon_color: "{{poi_dict.color}}" };
    pois.addFeatures(poi);
    map.addLayer(pois);
    pois.styleMap = poi_style_map;
    for (var i = 0; i< map.controls.length; i++) {
    control = map.controls[i];
    if (control.displayClass == "olControlNavigation")
        control.disableZoomWheel();
    else if (control.displayClass == "olControlLayerSwitcher")
        control.destroy();
    }
    map.zoomToExtent(pois.getDataExtent());
    map.zoomTo(map.getZoom()-3);
// map.zoomToExtent(vectors.getDataExtent());
}

function location_error() {
    alert('{% trans "cannot determine your current location" %}');
}
function show_path(loc) {
    var lat_1 = loc.coords.latitude;
    var lon_1 = loc.coords.longitude;
// var s = "http://muovi.roma.it/percorso/js?cr=1&cr_da=punto:({0},{1})&cr_a={2}";
    var s = "http://muovi.roma.it/percorso/js?cp=1&da=punto:({0},{1})&a={2}";
// address = "{{ poi_dict.street_name }}".replace(/ /g, '+')+'+'+"{{ poi_dict.number }}";
    address = "{{ poi_dict.street_address }}".replace(/ /g, '+');
    var url = s.format(lat_1, lon_1, address);
// window.open(url);
    var popup  = window.open("about:blank", "_blank"); // the about:blank is to please Chrome, and _blank to please Firefox
    popup.location = url;
}
function path_from_here() {
     geoPosition.getCurrentPosition(show_path, location_error);
}
DX = 700; // 450.0;
DY = 400; // 250.0;
function lookup_location() {
    geoPosition.getCurrentPosition(explore_location, location_error);
}
$(function() {
    if (geoPosition.init()) {
        $("#live-geolocation").html('<a href="#" onclick="lookup_location();return false"><i class="fa fa-location-arrow" aria-hidden="true"></i>  <small>{% trans "explore the zone around your current position" %}</small></a>');
        $("#muoviroma-percorso").html('<br /><div class="icon-hand-right"></div> <a href="#" onclick="path_from_here();return false">{% trans "find your way to this resource using the services by"|capfirst %} muoversiaroma.it</a>');
    } else {
// $("#muoviroma-percorso").html('<br /><div class="icon-hand-right"></div> <a href="http://muovi.roma.it/percorso/js?cr=1&cr_da={% trans "enter your current address" %}&cr_a={{ poi_dict.street_name }}+{{ poi_dict.number }}, Roma" target="_blank">{% trans "find your way to this resource using the services by"|capfirst %} muovi.roma.it</a>');
        $("#muoviroma-percorso").html('<br /><div class="icon-hand-right"></div> <a href="http://muovi.roma.it/percorso/js?cr=1&cr_da={% trans "enter your current address" %}&cr_a={{ poi_dict.street_address }}, Roma" target="_blank">{% trans "find your way to this resource using the services by"|capfirst %} muovi.roma.it</a>');
    }
});

map_init();
</script>
{% endblock mapjs %}
{% endif %}

{% block body_scripts %}
<script type="text/javascript">
 $(document).ready(function() {
    $('#explore_viewport').click(function (event) {
        event.preventDefault();
        explore_viewport();
    });
});
</script>
{% endblock body_scripts %}
